---
- name: Create service account for Spark
  user: name={{ spark_user }}
        system=yes
        home={{ spark_lib_dir }}
        shell={{ spark_user_shell }}
        state=present
        groups="{{ spark_user_groups | join(',') }}"
  tags: ["spark-user"]

- name: Make sure Spark configuration directory exists
  file: path="{{ spark_conf_dir }}"
        state=directory
  tags: ["config"]

- name: Make sure Spark logs and run directories exists
  file: path="{{ item }}" 
        owner={{ spark_user }}
        group={{ spark_user }}
        mode=0755
        state=directory
  with_items:
    - "{{ spark_log_dir }}"
    - "{{ spark_run_dir }}"
    - "{{ spark_main_dir }}"

- name: Download Spark
  get_url: url="{{ spark_mirror }}"                                                             
           dest="{{ spark_src_dir }}"

- name: Extract Spark
  unarchive: src="{{ spark_src_dir }}/{{ spark_tar_file }}"                                                          
             dest="{{ spark_usr_parent_dir }}"                                                       
             copy=no

- name: Move to appropriate directory
  command: mv /usr/lib/spark-1.6.1-bin-without-hadoop /usr/lib/spark-1.6.1
  when: /usr/lib/spark-1.6.1-bin-without-hadoop.exists == False

- name: Spark symlinks
  file: src="{{ item.src }}"
        dest="{{ item.dest }}"
        state=link
  with_items:
    - { src: "{{ spark_main_dir }}/conf", dest: "{{ spark_conf_dir }}/conf" }
  tags: ["symlinks"] 

- name: Set up SPARK_HOME environment variables
  template: src="spark-env.sh.j2"
            dest="{{ spark_main_dir }}/conf/spark-env.sh"
  tags: ["config"]

- name: Set up spark defaults config file
  template: src=spark-defaults.conf.j2
            dest="{{ spark_main_dir }}/conf/spark-defaults.conf"
  tags: ["config"]

- name: Ensure Spark environmental variables are set
  template:
    src: spark-env.sh.j2
    dest: /etc/profile.d/spark.sh
    mode: 0644

- name: reload profile
  shell: source /etc/profile.d/spark.sh

